(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function u(a=0){var t,i;const e=document.getElementById("loading");e&&(e.classList.remove("hidden"),document.getElementById("loadProgress").value=a,(t=document.getElementById("error"))==null||t.classList.add("hidden"),(i=document.getElementById("feedback"))==null||i.classList.add("hidden"))}function m(){const a=document.getElementById("loading");a&&a.classList.add("hidden")}function L(a){var t;m();const e=document.getElementById("feedback");e&&(e.textContent=a,e.classList.remove("hidden"),(t=document.getElementById("error"))==null||t.classList.add("hidden"))}function g(a){var t;m();const e=document.getElementById("error");e&&(e.textContent=a,e.classList.remove("hidden"),(t=document.getElementById("feedback"))==null||t.classList.add("hidden"))}function b(a){a.innerHTML=`
    <h2>Load Sitemap</h2>
    <form id="sitemapUrlForm" method="POST" class="input-group">
      <label for="sitemapUrlInput">Enter Sitemap URL:</label>
      <input type="text" id="sitemapUrlInput" name="url" placeholder="https://example.com/sitemap.xml" />
      <button type="submit">Load Sitemap</button>
    </form>
    <form id="sitemapUploadForm" method="POST" enctype="multipart/form-data" class="input-group">
      <label for="sitemapFile">Upload Sitemap File:</label>
      <input type="file" id="sitemapFile" name="sitemapFile" />
      <button type="submit">Upload</button>
    </form>
    <div class="button-group">
      <button id="clearCacheBtn" type="button">Clear Cache</button>
    </div>
    <div id="status">
      <div id="loading" class="hidden">
        <progress id="loadProgress" max="100" value="0"></progress>
        <span>Loading...</span>
      </div>
      <div id="feedback" class="hidden"></div>
      <div id="error" class="hidden"></div>
    </div>
  `;const e=a.querySelector("#sitemapUrlForm"),t=a.querySelector("#sitemapUrlInput"),i=a.querySelector("#sitemapUploadForm"),s=a.querySelector("#clearCacheBtn");return e.addEventListener("submit",async r=>{r.preventDefault();const o=t.value.trim();if(o){u(10);try{const n=await fetch("/sitemap/url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:o})});if(!n.ok){const l=await n.json();throw new Error(l.error||"Failed to fetch sitemap")}const{id:d}=await n.json();u(50),window.history.pushState({},"",`/results?id=${d}`),y("/results"),L("Sitemap loaded successfully")}catch(n){g(n.message)}finally{m()}}}),i.addEventListener("submit",async r=>{r.preventDefault();const o=new FormData(i);u(10);try{const n=await fetch("/sitemap/upload",{method:"POST",body:o});if(!n.ok){const l=await n.json();throw new Error(l.error||"Failed to upload sitemap")}const{id:d}=await n.json();u(50),window.history.pushState({},"",`/results?id=${d}`),y("/results"),L("Sitemap uploaded successfully")}catch(n){g(n.message)}finally{m()}}),s.addEventListener("click",async()=>{u();try{if(!(await fetch("/sitemap/clear-cache",{method:"POST"})).ok)throw new Error("Failed to clear cache");L("Cache cleared successfully"),setTimeout(()=>window.location.reload(),1e3)}catch(r){g(r.message)}finally{m()}}),{}}class E{constructor(e){this.container=e,this.isExpanded=!0,this.allToggles=[]}toggleExpansion(){this.isExpanded=!this.isExpanded;const e=this.container.querySelector("#toggleExpansionLink");e&&(e.innerHTML=this.isExpanded?'<i class="fas fa-compress-alt"></i> Collapse All':'<i class="fas fa-expand-alt"></i> Expand All',e.setAttribute("aria-expanded",this.isExpanded)),this.allToggles.forEach(t=>{t.classList.toggle("open",this.isExpanded),t.setAttribute("aria-expanded",this.isExpanded);const i=t.nextElementSibling;i&&i.classList.toggle("hidden",!this.isExpanded)})}render(e,t={},i="url"){u(50),this.container.innerHTML="",this.allToggles=[];const s=this.filterUrls(e,t),r=this.sortUrls(s,i),o=this.buildTree(r),n=document.createElement("ul");n.className="tree-list",this.renderTreeNode(o,n,"",!0),this.container.appendChild(n),m()}filterUrls(e,t){return e.filter(i=>{const s=parseFloat(i.priority)||0,r=i.lastmod?new Date(i.lastmod):null,o=parseFloat(t.priority)||0,n=t.lastmod?new Date(t.lastmod):null;return s>=o&&(!n||r&&r>=n)})}sortUrls(e,t){return e.sort((i,s)=>t==="lastmod"?new Date(s.lastmod||0)-new Date(i.lastmod||0)||i.loc.localeCompare(s.loc):t==="priority"&&parseFloat(s.priority||0)-parseFloat(i.priority||0)||i.loc.localeCompare(s.loc))}buildTree(e){const t={children:{},urls:[]};return e.forEach(i=>{try{const s=new URL(i.loc),r=s.pathname==="/"?[""]:s.pathname.split("/").filter(d=>d.length>0);let o=t;const n=s.hostname;o.children[n]||(o.children[n]={name:n,children:{},urls:[]}),o=o.children[n],r.forEach(d=>{const l=d||"/";o.children[l]||(o.children[l]={name:l,children:{},urls:[]}),o=o.children[l]}),o.urls.push(i)}catch(s){console.error(`Failed to parse URL: ${i.loc}`,s)}}),t}renderTreeNode(e,t,i,s=!1){Object.entries(e.children).forEach(([r,o])=>{const n=i?`${i}/${o.name}`:o.name,d=document.createElement("li"),l=document.createElement("span");if(l.className="toggle open",l.setAttribute("aria-expanded","true"),l.textContent=o.name==="/"?n:o.name,l.addEventListener("click",()=>this.toggleNode(l)),d.appendChild(l),this.allToggles.push(l),s){const c=document.createElement("a");c.href="#",c.id="toggleExpansionLink",c.setAttribute("aria-expanded","true"),c.innerHTML='<i class="fas fa-compress-alt"></i> Collapse All',c.style.marginLeft="10px",c.addEventListener("click",h=>{h.preventDefault(),this.toggleExpansion()}),d.appendChild(c)}if(o.urls.length>0){const c=document.createElement("ul");o.urls.forEach(h=>{const v=document.createElement("li");v.innerHTML=`<span class="url-leaf">${this.formatUrl(h)}</span>`,c.appendChild(v)}),d.appendChild(c)}if(Object.keys(o.children).length>0){const c=document.createElement("ul");this.renderTreeNode(o,c,n,!1),d.appendChild(c)}t.appendChild(d)})}formatUrl(e){let t=e.loc;return e.lastmod&&(t+=` (Last Modified: ${e.lastmod})`),e.changefreq&&(t+=`, ${e.changefreq}`),e.priority&&(t+=`, Priority: ${e.priority}`),t}toggleNode(e){const t=e.classList.contains("open");e.classList.toggle("open",!t),e.setAttribute("aria-expanded",!t);const i=e.nextElementSibling;i&&i.classList.toggle("hidden",t)}}class w{constructor(e,t={}){this.container=e,this.options={onApply:t.onApply||(()=>{}),onReset:t.onReset||(()=>{}),onSearch:t.onSearch||(()=>{}),...t},this.render(),this.setupEventListeners()}render(){this.container.innerHTML=`
      <label for="priorityFilter">Min Priority:</label>
      <input type="number" id="priorityFilter" min="0" max="1" step="0.1" value="0" />
      <label for="lastmodFilter">Last Modified After:</label>
      <input type="date" id="lastmodFilter" />
      <label for="sortBy">Sort By:</label>
      <select id="sortBy">
        <option value="url">URL</option>
        <option value="lastmod">Last Modified</option>
        <option value="priority">Priority</option>
      </select>
      <input type="text" id="urlSearch" placeholder="Search URLs..." />
      <button id="applyFiltersBtn">Apply Filters</button>
      <button id="resetFiltersBtn">Reset Filters</button>
    `}setupEventListeners(){this.container.querySelector("#applyFiltersBtn").addEventListener("click",()=>{const e={priority:this.container.querySelector("#priorityFilter").value,lastmod:this.container.querySelector("#lastmodFilter").value},t=this.container.querySelector("#sortBy").value;this.options.onApply(e,t)}),this.container.querySelector("#resetFiltersBtn").addEventListener("click",()=>{this.container.querySelector("#priorityFilter").value="0",this.container.querySelector("#lastmodFilter").value="",this.container.querySelector("#sortBy").value="url",this.container.querySelector("#urlSearch").value="",this.options.onReset()}),this.container.querySelector("#urlSearch").addEventListener("input",()=>{const e=this.container.querySelector("#urlSearch").value.toLowerCase();this.options.onSearch(e)})}toggleVisibility(e){this.container.classList.toggle("hidden",!e)}}function S(a){a.innerHTML=`
    <div id="filters" class="hidden"></div>
    <div id="stats">
      <p>Total URLs: <span id="totalUrls">0</span></p>
      <p>Unique Domains: <span id="uniqueDomains">0</span></p>
      <p>Matches: <span id="matchCount"></span></p>
    </div>
    <div id="tree" class="tree"></div>
    <div id="status">
      <div id="loading" class="hidden">
        <progress id="loadProgress" max="100" value="0"></progress>
        <span>Loading...</span>
      </div>
      <div id="feedback" class="hidden"></div>
      <div id="error" class="hidden"></div>
    </div>
  `;const e=a.querySelector("#filters"),t=a.querySelector("#tree"),i=new E(t);let s=[];const r=new w(e,{onApply:(n,d)=>{i.render(s,n,d);const l=t.querySelectorAll("li").length;a.querySelector("#matchCount").textContent=`(${l} of ${s.length} URLs)`},onReset:()=>{i.render(s),a.querySelector("#matchCount").textContent=""},onSearch:n=>{t.querySelectorAll("span").forEach(d=>{if(d.classList.remove("highlight"),n&&d.textContent.toLowerCase().includes(n)){d.classList.add("highlight");let l=d.closest("ul");for(;l;){l.classList.remove("hidden");const c=l.previousElementSibling;c&&c.classList.contains("toggle")&&(c.classList.add("open"),c.setAttribute("aria-expanded","true")),l=l.parentElement.closest("ul")}}})}});return(async()=>{const d=new URLSearchParams(window.location.search).get("id");if(!d){g("No sitemap ID provided. Please load a sitemap first.");return}u(10);try{const l=await fetch(`/sitemap/results-data?id=${d}`);if(!l.ok){const h=await l.json();throw new Error(h.error||"Failed to load sitemap data")}const c=await l.json();s=c.urls,u(50),i.render(s),u(100),L(`Loaded ${c.urlCount} URLs`),a.querySelector("#totalUrls").textContent=c.urlCount,a.querySelector("#uniqueDomains").textContent=new Set(s.map(h=>new URL(h.loc).hostname)).size,f.updateUrls(s)}catch(l){g(l.message)}finally{m()}})(),{treeView:i,onToggleFilters:n=>{r.toggleVisibility(n)},urls:s}}class x{constructor(e,t={}){this.container=e,this.options={onBack:()=>{window.history.pushState({},"","/"),y("/")},urls:t.urls||[],path:t.path||window.location.pathname,...t},this.render(),this.setupEventListeners()}render(){const e=this.options.path==="/results";this.container.innerHTML=`
      <button id="backBtn" ${e?"":'class="hidden"'}><i class="fas fa-arrow-left"></i> Back</button>
      <button id="exportHtmlBtn" ${!e||!this.options.urls.length?"disabled":""}><i class="fas fa-file-code"></i> Export HTML</button>
      <button id="exportCsvBtn" ${!e||!this.options.urls.length?"disabled":""}><i class="fas fa-file-csv"></i> Export CSV</button>
      <button id="exportJsonBtn" ${!e||!this.options.urls.length?"disabled":""}><i class="fas fa-file-code"></i> Export JSON</button>
      <button id="themeToggleBtn"><i class="fas fa-moon"></i> Toggle Theme</button>
    `}setupEventListeners(){var s,r;(s=this.container.querySelector("#backBtn"))==null||s.addEventListener("click",()=>this.options.onBack());const e=this.container.querySelector("#exportHtmlBtn");e&&e.addEventListener("click",()=>{const o=`
          <!DOCTYPE html>
          <html><body><h1>Sitemap URLs</h1><ul>
          ${this.options.urls.map(n=>`<li><a href="${n.loc}">${n.loc}</a> (Last Modified: ${n.lastmod})</li>`).join("")}
          </ul></body></html>`;this.downloadFile(o,"sitemap.html","text/html")});const t=this.container.querySelector("#exportCsvBtn");t&&t.addEventListener("click",()=>{const o=`URL,Last Modified,Change Frequency,Priority
`+this.options.urls.map(n=>`"${n.loc}","${n.lastmod}","${n.changefreq}","${n.priority}"`).join(`
`);this.downloadFile(o,"sitemap.csv","text/csv")});const i=this.container.querySelector("#exportJsonBtn");i&&i.addEventListener("click",()=>{const o=JSON.stringify(this.options.urls,null,2);this.downloadFile(o,"sitemap.json","application/json")}),(r=this.container.querySelector("#themeToggleBtn"))==null||r.addEventListener("click",()=>{document.body.classList.toggle("dark-mode")})}updateRoute(e){this.options.path=e,this.render(),this.setupEventListeners()}updateUrls(e){this.options.urls=e,this.render(),this.setupEventListeners()}updateOptions(e){this.options={...this.options,...e},this.render(),this.setupEventListeners()}downloadFile(e,t,i){const s=new Blob([e],{type:i}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}}class F{constructor(e,t={}){this.container=e,this.options={onBack:t.onBack||(()=>{}),onToggleFilters:t.onToggleFilters||(()=>{}),treeView:t.treeView||null,urls:t.urls||[],...t},this.path=window.location.pathname,this.render(),this.setupEventListeners()}render(){const e=this.path==="/results";this.container.innerHTML=`
      <h1>Sitemap Explorer</h1>
      <div class="controls"></div>
      <button id="toggleFiltersBtn" ${e?"":'class="hidden"'} aria-expanded="false"><i class="fas fa-filter"></i> Filters</button>
    `;const t=this.container.querySelector(".controls");this.buttons=new x(t,{onBack:this.options.onBack,urls:this.options.urls,path:this.path})}setupEventListeners(){var e;(e=this.container.querySelector("#toggleFiltersBtn"))==null||e.addEventListener("click",()=>{const t=this.container.querySelector("#toggleFiltersBtn"),i=t.getAttribute("aria-expanded")==="true";t.setAttribute("aria-expanded",!i),this.options.onToggleFilters(!i)})}updateRoute(e){this.path=e,this.render(),this.setupEventListeners()}updateUrls(e){this.options.urls=e,this.buttons.updateUrls(e)}updateOptions(e){this.options={...this.options,...e},this.buttons.updateOptions({onBack:this.options.onBack,urls:this.options.urls}),this.render(),this.setupEventListeners()}}let p=null,f=null;function y(a){if(!p){console.error("Main element not initialized yet");return}console.log("Routing to:",a),p.innerHTML="";let e={};switch(a){case"/":e=b(p);break;case"/results":e=S(p);break;default:p.innerHTML="<h2>404 - Page not found</h2>"}f&&(f.updateRoute(a),e.urls&&f.updateUrls(e.urls),(e.treeView||e.onToggleFilters)&&f.updateOptions({treeView:e.treeView,onToggleFilters:e.onToggleFilters}))}document.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("app");if(p=document.getElementById("view"),!p||!a){console.error("Required elements (#app or #view) not found in index.html");return}const e=document.createElement("header");a.insertBefore(e,p),f=new F(e),y(window.location.pathname),window.addEventListener("popstate",()=>y(window.location.pathname))});
